<polymer-element name="ceci-paypal-express" extends="ceci-element" attributes="paymentproxy checkouturl">
  <template>
    <style>
      :host {
        display: block;
        min-height: 50px;
        width: 100%;
      }

      :host #view[data-mode*="start"] *:not([data-mode*="start"]) { display: none; }
      :host #view[data-mode*="start"] *[data-mode*="start"] { display: block; }
      :host #view[data-mode*="loading"] *:not([data-mode*="loading"]) { display: none; }
      :host #view[data-mode*="loading"] *[data-mode*="loading"] { display: block; }
      :host #view[data-mode*="error"] *:not([data-mode*="error"]) { display: none; }
      :host #view[data-mode*="error"] *[data-mode*="error"] { display: block; }
      :host #view[data-mode*="paying"] *:not([data-mode*="paying"]) { display: none; }
      :host #view[data-mode*="paying"] *[data-mode*="paying"] { display: block; }
      :host #view[data-mode*="thanks"] *:not([data-mode*="thanks"]) { display: none; }
      :host #view[data-mode*="thanks"] *[data-mode*="thanks"] { display: block; }

      :host #view img {
        margin: 0 auto;
      }

      :host iframe {
        width: 100%;
        border: 0;
        padding: 0;
        margin: 0;
      }
    </style>
    <div id="view" data-mode="start">
      <div id="errorMessage" data-mode="error">{{errorMessage}}</div>
      <div data-mode="loading">Connecting to PayPal...</div>
      <div data-mode="thanks">Thank you for your contribution!</div>
      <img data-mode="start error thanks" src="https://www.paypalobjects.com/en_US/i/btn/btn_xpressCheckout.gif">
      <iframe id="paymentIframe" data-mode="paying" id="iframe" width="400" height="550"></iframe>
    </div>
  </template>
  <ceci-definition>
    {
      "name": "PayPal Express",
      "description": "PayPal Express Mobile Payments",
      "broadcasts": {
      },
      "listeners": {
      },
      "attributes": {
      }
    }
  </ceci-definition>
  <script>
    Polymer('ceci-paypal-express', {
      paymentproxy: 'http://appmaker-paypal-proxy.herokuapp.com',
      checkouturl: 'https://www.sandbox.paypal.com/checkoutnow',
      proxyParams: {},
      errorMessage: '',
      ready: function () {
        this.proxyParams = {
          PAYMENTREQUEST_0_AMT: '10',
          PAYMENTREQUEST_0_PAYMENTACTION: 'Sale',
          PAYMENTREQUEST_0_CURRENCYCODE: 'USD',
          PAYMENTREQUEST_0_ITEMAMT: '10',
          L_PAYMENTREQUEST_0_NAME0: 'Donation to UNICEF',
          L_PAYMENTREQUEST_0_DESC0: 'Donation to UNICEF for SoccerAID',
          L_PAYMENTREQUEST_0_AMT0: '10',
          L_PAYMENTREQUEST_0_QTY0: '1',
          SOLUTIONTYPE: 'Sole',
          METHOD: 'SetExpressCheckout'
        };
      },
      _hashCheckInterval: -1,
      startHashCheck: function (callback) {
        if (this._hashCheckInterval) {
          this.stopHashCheck();
        }

        var that = this;
        this._hashCheckInterval = setInterval(function () {
          var match = window.location.hash.match(/#paypal(return|cancel)[^\w]/);
          if (match && match[1]) {
            that.stopHashCheck();
            callback(match[1]);
          }
        }, 100);
      },
      stopHashCheck: function () {
        clearInterval(this._hashCheckInterval);
      },
      removePaypalHash: function () {
        var match = window.location.hash.match(/#paypal(return|cancel)[^\w]/);
        if (match) {
          window.location.hash = window.location.hash.substring(0, match.index) +
            window.location.hash.substring(match.index + match.length + 1);
        }
      },
      setViewMode: function (mode) {
        this.$.view.setAttribute('data-mode', mode);
      },
      onPaymentReturn: function () {
        this.setViewMode('thanks');
      },
      onPaymentCancel: function () {
        this.errorMessage = 'Payment was canceled.'
        this.setViewMode('error');
      },
      submit: function () {
        var that = this;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', this.paymentproxy + '/pay/expresscheckout/setexpresscheckout', true);

        this.proxyParams.RETURNURL = window.location.href + '#paypalreturn';
        this.proxyParams.CANCELURL =  window.location.href + '#paypalcancel';
        this.removePaypalHash();

        xhr.onload = function (e) {
          if (xhr.status > 400) {
            try {console.error(JSON.parse(xhr.response).error);}
            catch(e) {}
            that.errorMessage = 'Problem submitting payment request. Please try again.';
            that.setViewMode('error');
          }
          else {
            that.setViewMode('loading');
            var data = JSON.parse(xhr.response);
            that.$.paymentIframe.onload = function () {
              that.setViewMode('paying');
              that.startHashCheck(function (returnType) {
                that['onPayment' + returnType[0].toUpperCase() + returnType.substr(1)]();
              });
            };
            that.$.paymentIframe.src = that.checkouturl + '?token=' + data.response.decoded.TOKEN;
          }
        };
        var data = Object.keys(this.proxyParams).map(function (k) {return escape(k) + '=' + escape(that.proxyParams[k])}).join('&');
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
        xhr.send(data);
      }
    });
  </script>
</polymer-element>